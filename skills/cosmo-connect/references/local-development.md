# Local Development Guide

Run a Cosmo Router locally with Connect (gRPC) subgraphs. No controlplane or cloud connection needed.

## Prerequisites

- Go 1.25+
- Node.js 20+ and pnpm
- wgc CLI: `pnpm install -g wgc@latest`

## Subgraph File Structure

```
my-subgraph/
├── src/
│   ├── schema.graphql       # You write this
│   ├── main.go              # Plugin entrypoint (plugin mode)
│   └── service/
│       └── service.go       # gRPC implementation (you write this)
├── cmd/service/
│   └── main.go              # Standalone entrypoint (standalone mode)
├── generated/               # Auto-generated by wgc
│   ├── service.proto
│   ├── mapping.json
│   ├── service.pb.go
│   └── service_grpc.pb.go
└── bin/                     # Compiled plugin binary
```

## Standalone Mode (Step-by-Step)

### 1. Write GraphQL Schema

```graphql
extend schema
  @link(url: "https://specs.apollo.dev/federation/v2.5",
        import: ["@key", "@shareable", "@external"])

type Query {
  projects: [Project!]!
  project(id: ID!): Project
}

type Project @key(fields: "id") {
  id: ID!
  name: String!
  description: String
  status: ProjectStatus!
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  COMPLETED
}
```

### 2. Generate Proto and Mapping

```bash
wgc router plugin build ./path/to/subgraph --generate-only
# With custom Go module path:
wgc router plugin build ./path/to/subgraph --generate-only \
  --go-module-path github.com/your/module
```

### 3. Implement gRPC Service

Root query handler:
```go
func (s *ProjectsService) QueryProjects(ctx context.Context, req *pb.QueryProjectsRequest) (*pb.QueryProjectsResponse, error) {
    return &pb.QueryProjectsResponse{Result: myProjectsList}, nil
}
```

Entity lookup (batched, must return results in same order as keys):
```go
func (s *ProjectsService) LookupProjectById(ctx context.Context, req *pb.LookupProjectByIdRequest) (*pb.LookupProjectByIdResponse, error) {
    var results []*pb.Project
    for _, key := range req.Keys {
        results = append(results, findProjectByID(key.Id)) // nil if not found
    }
    return &pb.LookupProjectByIdResponse{Result: results}, nil
}
```

### 4. Standalone Server Entrypoint

```go
func main() {
    lis, _ := net.Listen("tcp", ":4011")
    s := grpc.NewServer()
    pb.RegisterProjectsServiceServer(s, &service.ProjectsService{})
    log.Fatal(s.Serve(lis))
}
```

### 5. Create graph.yaml

```yaml
version: 1
subgraphs:
  - name: employees
    routing_url: http://localhost:4001/graphql
    schema:
      file: ./path/to/schema.graphqls

  - name: projects
    routing_url: dns:///localhost:4011
    grpc:
      schema_file: ./path/to/src/schema.graphql
      proto_file: ./path/to/generated/service.proto
      mapping_file: ./path/to/generated/mapping.json
```

### 6. Compose and Run

```bash
# Compose
wgc router compose -i ./graph.yaml -o ./config.json

# Start subgraphs, then router:
ROUTER_CONFIG_PATH=./config.json go run ./cmd/router/main.go
```

## Plugin Mode (Step-by-Step)

Steps 1-3 are identical to standalone. Differences start at step 4.

### 4. Plugin Entrypoint (instead of standalone server)

```go
func main() {
    pl, err := routerplugin.NewRouterPlugin(func(s *grpc.Server) {
        s.RegisterService(&pb.ProjectsService_ServiceDesc, &service.ProjectsService{})
    }, routerplugin.WithLogger(hclog.Info))
    if err != nil {
        log.Fatalf("failed to create router plugin: %v", err)
    }
    pl.Serve()
}
```

Requires `github.com/wundergraph/cosmo/router-plugin` dependency.

### 5. Build Plugin Binary

```bash
wgc router plugin build ./path/to/subgraph \
  --go-module-path github.com/your/module
```

### 6. graph.yaml (plugin shape)

```yaml
version: 1
subgraphs:
  - name: projects
    plugin:
      version: 0.0.1
      path: ./path/to/plugin-dir
```

### 7. Compose, Copy, Run

```bash
wgc router compose -i ./graph.yaml -o ./config.json

# Copy plugin binaries to router
mkdir -p ./router/plugins/projects/bin
cp -a ./path/to/subgraph/bin/* ./router/plugins/projects/bin/

# Start router (plugins auto-launched)
ROUTER_CONFIG_PATH=./config.json \
PLUGINS_ENABLED=true \
PLUGINS_PATH=./plugins \
go run ./cmd/router/main.go
```

## graph.yaml Subgraph Shapes

**Standard GraphQL (HTTP):**
```yaml
- name: my-subgraph
  routing_url: http://localhost:4001/graphql
  schema:
    file: ./path/to/schema.graphqls
```

**Connect - Standalone gRPC:**
```yaml
- name: my-grpc-subgraph
  routing_url: dns:///localhost:4011
  grpc:
    schema_file: ./path/to/schema.graphql
    proto_file: ./path/to/generated/service.proto
    mapping_file: ./path/to/generated/mapping.json
```

**Connect - Plugin:**
```yaml
- name: my-plugin-subgraph
  plugin:
    version: 0.0.1
    path: ./path/to/plugin-dir
```

## Router Environment Variables

| Variable | Description |
|----------|-------------|
| `ROUTER_CONFIG_PATH` | Static config JSON. No controlplane/token needed when set. |
| `EXECUTION_CONFIG_FILE_PATH` | Alternative to `ROUTER_CONFIG_PATH` (newer). |
| `EXECUTION_CONFIG_FILE_WATCH` | Auto-reload config on file change (`true`). |
| `PLUGINS_ENABLED` | Enable plugin subprocess management (`true`). |
| `PLUGINS_PATH` | Directory with plugin subdirs containing binaries. |
| `CONFIG_PATH` | Router's own `config.yaml` (listen address, logging, etc.). |

## Proto Conventions

- **Queries**: `QueryFieldName(Request) returns (Response)`
- **Mutations**: `MutationFieldName(Request) returns (Response)`
- **Entity lookups**: `LookupTypeByKey(Request) returns (Response)` — batched
- **Nullable scalars**: `google.protobuf.StringValue`, `Int32Value`, etc.
- **Enums**: Prefixed (GraphQL `PLANNING` → proto `PROJECT_STATUS_PLANNING`), mapping.json handles translation

## Troubleshooting

| Problem | Fix |
|---------|-----|
| "GRAPH_API_TOKEN is required" | Set `ROUTER_CONFIG_PATH=./config.json` for static config mode |
| Plugin not starting | Check `PLUGINS_ENABLED=true` and binary at `<PLUGINS_PATH>/<name>/bin/<os>_<arch>/plugin` |
| "dns:/// not resolving" | Ensure gRPC server is running before starting router |
| Proto generation fails | Install: `go install google.golang.org/protobuf/cmd/protoc-gen-go@latest && go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest` |
